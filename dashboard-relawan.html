<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CivicaCare</title>

    <!-- Google Fonts untuk Tipografi -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Poppins:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Library Ikon Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <style>
        /* === Pengaturan Dasar === */
        :root {
            --primary-color: #6A38C2;
            /* Ungu */
            --primary-light: #F0EBf9;
            /* Ungu Muda */
            --secondary-color: #CC0000;
            /* Merah */
            --dark-text: #1a202c;
            --light-text: #555;
            --bg-light: #f7fafc;
            --border-color: #e2e8f0;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            /* Fallback color */
            background-image: url('bg.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            /* Membuat background tidak ikut scroll */
            color: var(--dark-text);
        }

        /* === Header / Navigation Bar === */
        .main-header {
            background-color: #fff;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .bg-image {
            background-image: url('bg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            width: 100%;
            height: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--dark-text);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            margin-right: 10px;
        }

        .logo h1 {
            font-family: 'Lora', serif;
            font-size: 1.8rem;
            margin: 0;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .nav-icon {
            font-size: 1.4rem;
            color: var(--light-text);
            cursor: pointer;
            position: relative;
        }

        .nav-icon .notification-dot {
            position: absolute;
            top: 0;
            right: -2px;
            width: 8px;
            height: 8px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            border: 1px solid #fff;
            display: none;
            /* Sembunyikan secara default, JS akan menampilkannya */
        }

        /* Style untuk pesan jika tidak ada penugasan */
        .no-assignment-message {
            text-align: center;
            color: var(--light-text);
            padding: 20px;
            font-style: italic;
            font-size: 0.95rem;
        }

        /* NEW: Status Badge Styles */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
            margin-left: 10px;
            /* Space from text */
            vertical-align: middle;
            /* Align with text */
        }

        .status-terjadwal {
            background-color: #007bff;
            /* Blue */
            color: #fff;
        }

        .status-ongoing {
            background-color: #ffc107;
            /* Yellow */
            color: #343a40;
        }

        .status-completed {
            background-color: #28a745;
            /* Green */
            color: #fff;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .close-button {
            background: none;
            border: none;
            font-size: 2rem;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-button:hover {
            color: #666;
        }

        .modal-body p {
            font-size: 1rem;
            color: var(--light-text);
            line-height: 1.6;
        }

        /* === Konten Utama === */
        main {
            padding: 40px;
        }

        /* === Banner Ajakan (CTA) === */
        .cta-banner {
            background-color: var(--primary-light);
            border: 1px solid var(--primary-color);
            border-radius: 12px;
            padding: 25px 30px;
            margin-bottom: 40px;
        }

        .cta-banner h2 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.5rem;
            color: var(--dark-text);
        }

        .cta-banner .cta-button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            display: inline-block;
            transition: background-color 0.3s;
        }

        .cta-banner .cta-button:hover {
            background-color: #592EAB;
        }

        /* === Kartu Dashboard === */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }

        .card {
            background-color: #fff;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            padding: 25px;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .card-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .card-body {
            flex-grow: 1;
            /* Membuat body mengambil sisa ruang */
            color: var(--light-text);
            line-height: 1.7;
        }

        .card-body ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .card-body li {
            padding: 5px 0;
        }

        .card-footer {
            margin-top: 20px;
            text-align: right;
        }

        .card-footer .detail-button {
            background-color: #fff;
            color: var(--primary-color);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid var(--primary-color);
            transition: all 0.3s;
        }

        .card-footer .detail-button:hover {
            background-color: var(--primary-color);
            color: #fff;
        }

        /* === Media Query untuk Responsif === */
        @media (max-width: 992px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-header {
                padding: 15px 20px;
            }

            main {
                padding: 20px;
            }

            .logo h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>

    <!-- Header / Navigation Bar -->
    <header class="main-header">
        <a href="#" class="logo">
            <img src="logo.png" alt="Logo Icon CivicaCare" class="logo-icon">
            <h1>CivicaCare</h1>
        </a>
        <nav class="header-nav">
            <a href="riwayat-notifikasi.html" class="nav-icon">
                <i class="fa-solid fa-bell"></i>
                <span class="notification-dot"></span>
            </a>
            <a href="profile-relawan.html" class="nav-icon"><i class="fa-solid fa-user-circle"></i></a>
            <i id="logout-button" class="fa-solid fa-right-from-bracket nav-icon" title="Logout"></i>
        </nav>
    </header>

    <!-- Konten Utama -->
    <main>
        <!-- Banner Ajakan -->
        <div class="cta-banner">
            <h2>Lengkapi Pendaftaran Anda!</h2>
            <p>Hanya satu langkah lagi untuk menjadi bagian dari relawan hebat kami.</p>
            <a href="form-pendaftaran-relawan.html" class="cta-button" id="isi-formulir-button">Isi Formulir</a>
        </div>

        <!-- Kartu Koordinator (NEW) -->
        <div class="card" id="koordinator-card" style="display: none; margin-bottom: 40px;">
            <div class="card-header">
                <i class="fa-solid fa-user-tie card-icon"></i>
                <h3>Tugas Koordinator</h3>
            </div>
            <div class="card-body" id="koordinator-content">
                <p>Anda adalah koordinator untuk kegiatan berikut:</p>
                <ul id="coordinated-activities-list">
                    <!-- Coordinated activities will be listed here -->
                </ul>
            </div>
            <div class="card-footer" id="koordinator-footer" style="display: none;">
                <!-- This link would lead to a dedicated coordinator dashboard or a filtered view -->
                <a href="koordinator-dashboard.html" class="detail-button">Lihat Semua Tugas Koordinator</a>
            </div>
        </div>


        <!-- Kartu Dashboard -->
        <div class="dashboard-cards">
            <!-- Kartu Penugasan Saya -->
            <div class="card">
                <div class="card-header">
                    <i class="fa-solid fa-calendar-days card-icon"></i>
                    <h3>Penugasan Saya</h3>
                </div>
                <div class="card-body" id="penugasan-content">
                    <p>Silakan lengkapi formulir pendaftaran untuk melihat penugasan Anda.</p>
                </div>
            </div>

            <!-- Kartu Riwayat Evaluasi -->
            <div class="card">
                <div class="card-header">
                    <i class="fa-solid fa-chart-line card-icon"></i>
                    <h3>Riwayat Evaluasi</h3>
                </div>
                <div class="card-body" id="evaluasi-content">
                    <p>Silakan lengkapi formulir pendaftaran untuk melihat riwayat evaluasi Anda.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Debugging: Log values at start ---
            const loggedInUser = localStorage.getItem('loggedInUser');
            const loggedInUserRole = localStorage.getItem('loggedInUserRole');
            console.log("Dashboard Load: loggedInUser =", loggedInUser);
            console.log("Dashboard Load: loggedInUserRole =", loggedInUserRole);

            // --- Data Loading Functions ---
            async function loadActivities() {
                let activities = JSON.parse(localStorage.getItem('activitiesData'));
                return activities || [];
            }

            async function loadApplicants() {
                let applicants = JSON.parse(localStorage.getItem('applicantsData'));
                return applicants || [];
            }

            async function loadAssignments() {
                let assignments = JSON.parse(localStorage.getItem('assignmentsData'));
                return assignments || [];
            }

            async function loadVolunteerEvaluations() {
                let evaluations = JSON.parse(localStorage.getItem('volunteerEvaluationsData'));
                return evaluations || [];
            }

            // --- PENTING: Cek Autentikasi ---
            if (!loggedInUser) {
                alert('Anda harus login untuk mengakses dashboard.');
                window.location.href = 'login.html'; // Redirect ke halaman login
                return; // Hentikan eksekusi skrip lebih lanjut
            } else if (loggedInUserRole !== 'relawan') {
                alert('Akses ditolak. Anda tidak memiliki izin untuk melihat halaman ini.');
                window.location.href = 'login.html'; // Redirect ke halaman login
                return;
            }

            const loggedInVolunteerId = localStorage.getItem('loggedInVolunteerId'); // ID relawan yang login
            const ctaBanner = document.querySelector('.cta-banner');
            const penugasanContent = document.getElementById('penugasan-content'); // Konten penugasan
            const evaluasiContent = document.getElementById('evaluasi-content'); // Konten evaluasi
            const penugasanCard = penugasanContent.parentElement; // Card penugasan
            const evaluasiCard = evaluasiContent.parentElement; // Card evaluasi
            const notificationDot = document.querySelector('.notification-dot');

            // --- Main Render Function ---
            async function renderDashboardContent() {
                let applicantStatus = null;
                let myApplicantData = null;

                console.log("renderDashboardContent: loggedInVolunteerId =", loggedInVolunteerId);
                if (loggedInVolunteerId) {
                    const applicants = await loadApplicants();
                    console.log("renderDashboardContent: applicantsData loaded:", applicants);
                    myApplicantData = applicants.find(app => app.id === loggedInVolunteerId);
                    if (myApplicantData) {
                        applicantStatus = myApplicantData.status;
                    }
                }

                // --- Handle CTA Banner Display ---
                console.log("renderDashboardContent: applicantStatus =", applicantStatus);
                if (ctaBanner) {
                    if (applicantStatus === 'diajukan' || applicantStatus === 'diseleksi' || applicantStatus === 'diterima') {
                        ctaBanner.style.display = 'none'; // Hide banner if application is submitted or accepted
                    } else if (applicantStatus === 'ditolak') {
                        ctaBanner.style.display = 'block';
                        ctaBanner.querySelector('h2').textContent = 'Perbaiki Pendaftaran Anda';
                        ctaBanner.querySelector('p').textContent = 'Pengajuan Anda sebelumnya ditolak. Silakan periksa kembali data Anda dan ajukan ulang.';
                        ctaBanner.querySelector('.cta-button').textContent = 'Perbaiki Formulir';
                    }
                    else { // Not submitted yet
                        ctaBanner.style.display = 'block';
                        // Reset to default text in case it was changed from 'ditolak'
                        ctaBanner.querySelector('h2').textContent = 'Lengkapi Pendaftaran Anda!';
                        ctaBanner.querySelector('p').textContent = 'Hanya satu langkah lagi untuk menjadi bagian dari relawan hebat kami.';
                        ctaBanner.querySelector('.cta-button').textContent = 'Isi Formulir';
                    }
                }

                // --- Tampilkan Kartu Koordinator ---
                if (applicantStatus === 'diterima' && myApplicantData && myApplicantData.role === 'koordinator') {
                    const koordinatorCard = document.getElementById('koordinator-card');
                    const koordinatorContent = document.getElementById('koordinator-content');
                    const koordinatorFooter = document.getElementById('koordinator-footer');
                    const coordinatedActivitiesList = document.getElementById('coordinated-activities-list');

                    koordinatorCard.style.display = 'flex'; // Show the coordinator card

                    const allAssignments = await loadAssignments();
                    const myCoordinatedAssignments = allAssignments.filter(assign =>
                        assign.assigned_coordinator_id === loggedInVolunteerId &&
                        (assign.status === 'terjadwal' || assign.status === 'ongoing') // Only show active coordinated activities
                    ).sort((a, b) => {
                        // Sort by date and then by time (earliest first)
                        const dateA = new Date(`${a.date}T${(a.time || '00:00').split(' - ')[0].trim()}`);
                        const dateB = new Date(`${b.date}T${(b.time || '00:00').split(' - ')[0].trim()}`);
                        return dateA - dateB;
                    });

                    if (myCoordinatedAssignments.length > 0) {
                        coordinatedActivitiesList.innerHTML = ''; // Clear previous list
                        myCoordinatedAssignments.slice(0, 3).forEach(assign => { // Show top 3 for brevity
                            const li = document.createElement('li');
                            li.innerHTML = `<strong>${assign.activity_name}</strong> (${new Date(assign.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' })}) - <span class="status-badge status-${assign.status}">${getBadgeText(assign.status)}</span>`;
                            coordinatedActivitiesList.appendChild(li);
                        });
                        if (myCoordinatedAssignments.length > 3) {
                            const li = document.createElement('li');
                            li.textContent = `... dan ${myCoordinatedAssignments.length - 3} kegiatan lainnya.`;
                            coordinatedActivitiesList.appendChild(li);
                        }
                        koordinatorFooter.style.display = 'block';
                    } else {
                        koordinatorContent.innerHTML = `<p class="no-assignment-message">Anda belum ditugaskan sebagai koordinator untuk kegiatan apapun yang akan datang atau sedang berlangsung.</p>`;
                        koordinatorFooter.style.display = 'none';
                    }
                } else {
                    document.getElementById('koordinator-card').style.display = 'none'; // Hide if not a coordinator
                }

                // --- Reminder Notifikasi Penugasan (1 hari sebelum) ---
                if (applicantStatus === 'diterima') {
                    const userAssignmentsKey = 'userAssignments_' + loggedInUser;
                    const userAssignments = JSON.parse(localStorage.getItem(userAssignmentsKey) || '[]');
                    const sentRemindersKey = 'sentAssignmentReminders_' + loggedInUser;
                    let sentReminders = JSON.parse(localStorage.getItem(sentRemindersKey) || '[]');

                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Normalize today to start of day

                    userAssignments.forEach(assignment => {
                        const assignmentDate = new Date(assignment.date);
                        assignmentDate.setHours(0, 0, 0, 0); // Normalize assignment date

                        const reminderDate = new Date(assignmentDate);
                        reminderDate.setDate(assignmentDate.getDate() - 1); // Set reminder for 1 day before

                        // Check if reminder is due today and hasn't been sent yet for this assignment
                        const isReminderDue = reminderDate.getTime() === today.getTime();
                        const hasReminderBeenSent = sentReminders.some(r => r.assignmentId === assignment.id && r.reminderDate === today.toISOString().split('T')[0]);

                        if (isReminderDue && !hasReminderBeenSent) {
                            const notificationKey = 'userNotifications_' + loggedInUser;
                            let notifications = JSON.parse(localStorage.getItem(notificationKey) || '[]');
                            notifications.push({
                                type: 'assignment_reminder',
                                title: 'Pengingat Penugasan Besok!',
                                message: `Penugasan "${assignment.activity_name}" akan dilaksanakan besok, ${new Date(assignment.date).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })} di ${assignment.location}.`,
                                read: false
                            });
                            localStorage.setItem(notificationKey, JSON.stringify(notifications));
                            sentReminders.push({ assignmentId: assignment.id, reminderDate: today.toISOString().split('T')[0] });
                            localStorage.setItem(sentRemindersKey, JSON.stringify(sentReminders));
                        }
                    });
                }

                // [NEW] Tambahkan notifikasi bahwa formulir telah diterima
                if (applicantStatus === 'diterima') {
                    showFormAcceptedNotification();
                }

                // --- Tampilkan Penugasan Saya (berdasarkan status pendaftaran) ---
                if (applicantStatus === 'diterima') {
                    // Load all assignments and filter for the current volunteer
                    const allAssignments = await loadAssignments();
                    const now = new Date();

                    // Filter for assignments that are assigned to the current volunteer AND are either:
                    // 1. Scheduled and in the future (or exactly now)
                    // 2. Currently ongoing
                    let relevantAssignments = allAssignments.filter(assign => {
                        const isAssignedToMe = assign.assigned_volunteer_ids && assign.assigned_volunteer_ids.includes(loggedInVolunteerId);
                        if (!isAssignedToMe) return false;

                        const startTimeString = (assign.time || '00:00').split(' - ')[0].trim();
                        const assignmentStartDateTime = new Date(`${assign.date}T${startTimeString}`);

                        if (assign.status === 'terjadwal') {
                            // Only include if the start time is in the future or exactly now
                            return assignmentStartDateTime >= now;
                        } else if (assign.status === 'ongoing') {
                            return true; // Always include ongoing assignments
                        }
                        return false; // Exclude completed and other statuses from this card
                    });

                    // Save filtered assignments to the user's specific key
                    const userAssignmentsKey = 'userAssignments_' + loggedInUser;
                    localStorage.setItem(userAssignmentsKey, JSON.stringify(relevantAssignments));

                    // Use myAssignments for display logic
                    let userAssignments = JSON.parse(localStorage.getItem(userAssignmentsKey) || '[]'); // Re-read to ensure consistency

                    // If no assignments are found for this volunteer, display a message
                    if (userAssignments.length === 0) {
                        penugasanContent.innerHTML = `<p class="no-assignment-message">Belum ada penugasan yang akan datang atau sedang berlangsung untuk Anda.</p>`;
                        const existingFooter = penugasanCard.querySelector('.card-footer');
                        if (existingFooter) existingFooter.remove();
                    } else {
                        let assignmentToDisplay = null;
                        const currentSelectedAssignmentId = localStorage.getItem('currentSelectedAssignmentId_' + loggedInUser);

                        if (currentSelectedAssignmentId) {
                            assignmentToDisplay = userAssignments.find(a => a.id === currentSelectedAssignmentId);
                        }
                        // Jika tidak ada yang dipilih atau yang dipilih tidak ditemukan, cari yang paling awal (terdekat)
                        if (!assignmentToDisplay && userAssignments.length > 0) {
                            assignmentToDisplay = userAssignments
                                .sort((a, b) => {
                                    // Sort by date and then by time (earliest first)
                                    const dateA = new Date(`${a.date}T${(a.time || '00:00').split(' - ')[0].trim()}`);
                                    const dateB = new Date(`${b.date}T${(b.time || '00:00').split(' - ')[0].trim()}`);
                                    return dateA - dateB;
                                })[0]; // Get the earliest one
                        }
                        if (assignmentToDisplay) {
                            penugasanContent.innerHTML = `<p>
                                <strong>Berikutnya:</strong> ${assignmentToDisplay.activity_name} <span class="status-badge status-${assignmentToDisplay.status}">${getBadgeText(assignmentToDisplay.status)}</span><br>
                                <strong>Tanggal:</strong> ${new Date(assignmentToDisplay.date).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}<br>
                                <strong>Lokasi:</strong> ${assignmentToDisplay.location}
                            </p>`;
                            // Hapus footer lama jika ada untuk mencegah duplikasi saat hot-reload/refresh
                            const existingFooter = penugasanCard.querySelector('.card-footer');
                            if (existingFooter) {
                                existingFooter.remove();
                            }
                            const penugasanFooter = document.createElement('div');
                            penugasanFooter.className = 'card-footer';
                            penugasanFooter.innerHTML = `<a href="detail-penugasan.html?id=${assignmentToDisplay.id}" class="detail-button">Lihat Detail</a>`;
                            penugasanCard.appendChild(penugasanFooter);
                        } else {
                            penugasanContent.innerHTML = `<p class="no-assignment-message">Belum ada penugasan yang tersedia untuk Anda.</p>`;
                            const existingFooter = penugasanCard.querySelector('.card-footer');
                            if (existingFooter) existingFooter.remove();
                        }
                    }
                } else if (applicantStatus === 'diajukan' || applicantStatus === 'diseleksi') {
                    penugasanContent.innerHTML = `<p class="no-assignment-message">Penugasan akan ditampilkan setelah pendaftaran Anda disetujui admin.</p>`;
                    const existingFooter = penugasanCard.querySelector('.card-footer');
                    if (existingFooter) existingFooter.remove();
                } else if (applicantStatus === 'ditolak') {
                    penugasanContent.innerHTML = `<p class="no-assignment-message">Pendaftaran Anda ditolak. Silakan hubungi admin untuk informasi lebih lanjut.</p>`;
                    const existingFooter = penugasanCard.querySelector('.card-footer');
                    if (existingFooter) existingFooter.remove();
                } else { // loggedInVolunteerId is null or applicant not found in applicantsData (meaning form not submitted yet)
                    penugasanContent.innerHTML = `<p>Silakan lengkapi formulir pendaftaran untuk melihat penugasan Anda.</p>`;
                    const existingFooter = penugasanCard.querySelector('.card-footer');
                    if (existingFooter) existingFooter.remove();
                }

                // --- Tampilkan Riwayat Evaluasi (Dinamis) ---
                if (applicantStatus === 'diterima') {
                    const volunteerEvaluations = await loadVolunteerEvaluations();

                    const myEvaluations = volunteerEvaluations.filter(eval => eval.volunteer_id === loggedInVolunteerId);

                    let totalScoreSum = 0;
                    let totalCriteriaCount = 0;
                    let latestFeedback = '';
                    let latestActivityName = '';

                    if (myEvaluations.length > 0) {
                        // Sort by evaluated_at to get the latest
                        myEvaluations.sort((a, b) => new Date(b.evaluated_at) - new Date(a.evaluated_at));

                        myEvaluations.forEach(eval => {
                            totalScoreSum += eval.kedisiplinan + eval.komunikasi + eval.kerjasama + eval.tanggung_jawab;
                            totalCriteriaCount += 4; // Each evaluation has 4 criteria
                        });

                        const overallAvgScore = totalCriteriaCount > 0 ? (totalScoreSum / totalCriteriaCount).toFixed(1) : 'N/A';
                        latestFeedback = myEvaluations[0].umpan_balik || 'Tidak ada umpan balik.';

                        // Untuk mendapatkan nama kegiatan terbaru, kita perlu load activities
                        const activities = await loadActivities(); // Use the async loadActivities function
                        const latestActivity = activities.find(act => act.id === myEvaluations[0].activity_id);
                        latestActivityName = latestActivity ? latestActivity.nama_kegiatan : 'Kegiatan Tidak Ditemukan';

                        evaluasiContent.innerHTML = `<p>
                            <strong>Rata-rata Skor:</strong> ${overallAvgScore} / 5.0<br>
                            <strong>Evaluasi Terbaru:</strong> ${latestActivityName}<br>
                            <strong>Umpan Balik:</strong> ${latestFeedback.length > 50 ? latestFeedback.substring(0, 50) + '...' : latestFeedback}
                        </p>`;
                    } else {
                        evaluasiContent.innerHTML = `<p class="no-assignment-message">Belum ada evaluasi yang tersedia untuk Anda.</p>`;
                    }

                    // Hapus footer lama jika ada untuk mencegah duplikasi
                    const existingEvalFooter = evaluasiCard.querySelector('.card-footer');
                    if (existingEvalFooter) {
                        existingEvalFooter.remove();
                    }
                    const evaluasiFooter = document.createElement('div');
                    evaluasiFooter.className = 'card-footer';
                    evaluasiFooter.innerHTML = `<a href="detail-evaluasi.html" class="detail-button">Lihat Riwayat</a>`;
                    evaluasiCard.appendChild(evaluasiFooter);
                } else if (applicantStatus === 'diajukan' || applicantStatus === 'diseleksi') {
                    evaluasiContent.innerHTML = `<p class="no-assignment-message">Riwayat evaluasi akan ditampilkan setelah pendaftaran Anda disetujui admin.</p>`;
                    const existingEvalFooter = evaluasiCard.querySelector('.card-footer');
                    if (existingEvalFooter) existingEvalFooter.remove();
                } else if (applicantStatus === 'ditolak') {
                    evaluasiContent.innerHTML = `<p class="no-assignment-message">Pendaftaran Anda ditolak. Riwayat evaluasi tidak tersedia.</p>`;
                    const existingEvalFooter = evaluasiCard.querySelector('.card-footer');
                    if (existingEvalFooter) existingEvalFooter.remove();
                } else { // loggedInVolunteerId is null or applicant not found in applicantsData (meaning form not submitted yet)
                    evaluasiContent.innerHTML = `<p>Silakan lengkapi formulir pendaftaran untuk melihat riwayat evaluasi Anda.</p>`;
                    const existingEvalFooter = evaluasiCard.querySelector('.card-footer');
                    if (existingEvalFooter) existingEvalFooter.remove();
                }

                // [NEW] Tambahkan notifikasi bahwa formulir telah diterima
                if (applicantStatus === 'diterima') {
                    showFormAcceptedNotification();
                }
            }

            // Helper function to get badge text
            function getBadgeText(status) {
                switch (status) {
                    case 'terjadwal': return 'Terjadwal';
                    case 'ongoing': return 'Berlangsung';
                    case 'completed': return 'Selesai';
                    default: return status;
                }
            }

            // Function to update the notification dot visibility
            function updateNotificationDot() {
                const loggedInUser = localStorage.getItem('loggedInUser');
                const notificationKey = 'userNotifications_' + loggedInUser;
                const notifications = JSON.parse(localStorage.getItem(notificationKey) || '[]');
                const hasUnread = notifications.some(notif => notif.read === false);

                if (hasUnread && notificationDot) {
                    notificationDot.style.display = 'block';
                } else if (notificationDot) {
                    notificationDot.style.display = 'none';
                }
            }

            // Fungsi untuk menampilkan notifikasi jika formulir diterima
            function showFormAcceptedNotification() {
                const loggedInUser = localStorage.getItem('loggedInUser');
                const notificationKey = 'userNotifications_' + loggedInUser;
                let notifications = JSON.parse(localStorage.getItem(notificationKey) || '[]');

                // Cek apakah notifikasi sudah ada
                const existingNotification = notifications.find(notif => notif.type === 'form_accepted_admin');
                if (!existingNotification) {
                    notifications.push({
                        type: 'form_accepted_admin',
                        title: 'Pendaftaran Disetujui!',
                        message: 'Selamat! Pendaftaran Anda telah disetujui oleh admin. Sekarang Anda dapat melihat penugasan dan riwayat evaluasi.',
                        read: false
                    });
                    localStorage.setItem(notificationKey, JSON.stringify(notifications));
                    updateNotificationDot(); // Tampilkan dot notifikasi
                }
            }

            // --- Check for Unread Notifications ---
            if (loggedInUser) {
                const notificationKey = 'userNotifications_' + loggedInUser;
                const notifications = JSON.parse(localStorage.getItem(notificationKey) || '[]');
                const hasUnread = notifications.some(notif => notif.read === false);

                if (hasUnread && notificationDot) {
                    notificationDot.style.display = 'block';
                } else if (notificationDot) {
                    notificationDot.style.display = 'none';
                }
            }

            // --- Initial Render Call ---
            renderDashboardContent();

            // --- Logout Logic ---
            const logoutButton = document.getElementById('logout-button'); // Pastikan ini di dalam DOMContentLoaded
            if (logoutButton) {
                logoutButton.addEventListener('click', function (event) {
                    event.preventDefault();

                    // Hapus hanya data sesi pengguna, bukan data aplikasi
                    localStorage.removeItem('loggedInUser');
                    localStorage.removeItem('loggedInUserEmail');
                    localStorage.removeItem('loggedInUserRole');
                    localStorage.removeItem('loggedInVolunteerId');
                    localStorage.removeItem('userAssignments_' + loggedInUser);
                    localStorage.removeItem('sentAssignmentReminders_' + loggedInUser);

                    // Arahkan ke halaman login
                    window.location.href = 'login.html';
                });
            }
        });
    </script>

</body>

</html>