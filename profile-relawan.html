<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Saya - CivicaCare</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Poppins:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <style>
        /* === Pengaturan Dasar === */
        :root {
            --primary-color: #6A38C2;
            /* Ungu */
            --primary-light: #F0EBf9;
            /* Ungu Muda */
            --secondary-color: #CC0000;
            /* Merah */
            --dark-text: #1a202c;
            --light-text: #555;
            --bg-light: #f7fafc;
            --border-color: #e2e8f0;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            background-image: url('bg.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--dark-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* === Header === */
        .main-header {
            background-color: #fff;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--dark-text);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            margin-right: 10px;
        }

        .logo h1 {
            font-family: 'Lora', serif;
            font-size: 1.8rem;
            margin: 0;
        }

        .back-button {
            background-color: transparent;
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            border: 1px solid var(--primary-color);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-button:hover {
            background-color: var(--primary-color);
            color: #fff;
        }

        /* === Konten Utama === */
        main {
            flex-grow: 1;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            /* Align to top for longer content */
        }

        .profile-container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .profile-container h2 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        /* === Profile Actions Container === */
        .profile-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .toggle-resign-button {
            background-color: transparent;
            color: var(--secondary-color);
            padding: 12px 25px;
            border-radius: 8px;
            border: 1px solid var(--secondary-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-resign-button:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 0;
            /* Handled by grid gap */
        }

        .form-group.span-two-columns {
            grid-column: span 2;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #fdfdfd;
            /* Light background for inputs */
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            color: var(--dark-text);
            cursor: pointer;
            font-weight: normal;
            /* Override form-label */
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .save-button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }

        .save-button:hover {
            background-color: #592EAB;
        }

        /* === Resignation Section === */
        .resignation-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .resignation-section h3 {
            font-size: 1.5rem;
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        .resignation-section p {
            color: var(--light-text);
            margin-bottom: 20px;
        }

        .resignation-section .file-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .resignation-section input[type="file"] {
            width: 80%;
            max-width: 350px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .resignation-section small {
            color: #777;
            font-size: 0.85rem;
        }

        .resign-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .resign-button:hover {
            background-color: #a00000;
        }

        .error-message {
            color: var(--secondary-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        /* Media Queries */
        @media (max-width: 768px) {
            main {
                padding: 20px;
            }

            .profile-container {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-group.span-two-columns {
                grid-column: span 1;
            }

            .resignation-section input[type="file"] {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="main-header">
        <a href="dashboard-relawan.html" class="back-button">
            <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
        </a>
        <a href="#" class="logo">
            <img src="logo.png" alt="Logo Icon CivicaCare" class="logo-icon">
            <h1>CivicaCare</h1>
        </a>
    </header>

    <!-- Konten Utama -->
    <main>
        <div class="profile-container">
            <h2>Profil Saya</h2>
            <form id="profile-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="profile-name" class="form-label">Nama Lengkap</label>
                        <input type="text" id="profile-name" class="form-input" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profile-nik" class="form-label">NIK</label>
                        <input type="text" id="profile-nik" class="form-input" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profile-phone" class="form-label">Nomor Telepon</label>
                        <input type="text" id="profile-phone" class="form-input" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profile-email" class="form-label">Email</label>
                        <input type="email" id="profile-email" class="form-input" readonly>
                    </div>
                    <div class="form-group span-two-columns">
                        <label for="profile-address" class="form-label">Alamat</label>
                        <textarea id="profile-address" class="form-textarea" rows="3" readonly></textarea>
                    </div>
                    <div class="form-group span-two-columns">
                        <label for="profile-education" class="form-label">Pendidikan Terakhir</label>
                        <input type="text" id="profile-education" class="form-input" readonly>
                    </div>

                    <div class="form-group span-two-columns">
                        <label class="form-label">Jadwal Ketersediaan (Dapat Diubah)</label>
                        <div class="checkbox-group" id="profile-availability-group">
                            <label><input type="checkbox" name="availability" value="senin"> Senin</label>
                            <label><input type="checkbox" name="availability" value="selasa"> Selasa</label>
                            <label><input type="checkbox" name="availability" value="rabu"> Rabu</label>
                            <label><input type="checkbox" name="availability" value="kamis"> Kamis</label>
                            <label><input type="checkbox" name="availability" value="jumat"> Jumat</label>
                            <label><input type="checkbox" name="availability" value="sabtu"> Sabtu</label>
                            <label><input type="checkbox" name="availability" value="minggu"> Minggu</label>
                        </div>
                    </div>
                </div>
                <div class="profile-actions">
                    <button type="submit" class="save-button" id="save-profile-button">Simpan Perubahan
                        Ketersediaan</button>
                    <button type="button" class="toggle-resign-button" id="toggle-resign-button">Opsi Pengunduran
                        Diri</button>
                </div>
            </form>

            <div class="resignation-section" id="resignation-section" style="display: none;">
                <h3>Mengundurkan Diri sebagai Relawan</h3>
                <p>Jika Anda ingin mengundurkan diri dari CivicaCare, mohon unggah surat pengunduran diri atau dokumen
                    pendukung lainnya.</p>
                <div class="file-input-group">
                    <input type="file" id="resignation-document" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                    <small>Format: PDF, DOCX, JPG, PNG (Max 2MB)</small>
                    <div class="error-message" id="resignation-document-error"></div>
                </div>
                <button class="resign-button" id="resign-button">Ajukan Pengunduran Diri</button>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const loggedInUser = localStorage.getItem('loggedInUser');
            const loggedInUserRole = localStorage.getItem('loggedInUserRole');
            const loggedInVolunteerId = localStorage.getItem('loggedInVolunteerId');

            // --- Autentikasi dan Redirect ---
            if (!loggedInUser || loggedInUserRole !== 'relawan' || !loggedInVolunteerId) {
                alert('Anda harus login sebagai relawan untuk mengakses halaman ini.');
                window.location.href = 'login.html';
                return;
            }
            // --- Elemen Tambahan ---
            const toggleResignButton = document.getElementById('toggle-resign-button');

            // --- Elemen Form ---
            const profileName = document.getElementById('profile-name');
            const profileNik = document.getElementById('profile-nik');
            const profilePhone = document.getElementById('profile-phone');
            const profileEmail = document.getElementById('profile-email');
            const profileAddress = document.getElementById('profile-address');
            const profileEducation = document.getElementById('profile-education');
            const profileAvailabilityGroup = document.getElementById('profile-availability-group');
            const availabilityCheckboxes = profileAvailabilityGroup.querySelectorAll('input[type="checkbox"]');
            const saveProfileButton = document.getElementById('save-profile-button');

            // --- Elemen Resignation ---
            const resignationDocumentInput = document.getElementById('resignation-document');
            const resignationDocumentError = document.getElementById('resignation-document-error');
            const resignButton = document.getElementById('resign-button');

            const MAX_FILE_SIZE_MB = 2;
            const ALLOWED_FILE_TYPES = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/png'];
            const resignationSection = document.getElementById('resignation-section');

            let currentVolunteerData = null; // To store the loaded volunteer data

            // --- Data Loading Functions ---
            async function loadApplicants() {
                let applicants = JSON.parse(localStorage.getItem('applicantsData'));
                return applicants || [];
            }

            function saveApplicants(applicants) {
                localStorage.setItem('applicantsData', JSON.stringify(applicants));
            }

            // --- Populate Profile Form ---
            async function populateProfile() {
                const applicants = await loadApplicants();
                currentVolunteerData = applicants.find(app => app.id === loggedInVolunteerId);

                if (currentVolunteerData) {
                    profileName.value = currentVolunteerData.name || '';
                    profileNik.value = currentVolunteerData.nik || '';
                    profilePhone.value = currentVolunteerData.phone || '';
                    profileEmail.value = currentVolunteerData.email || '';
                    profileAddress.value = currentVolunteerData.address || '';
                    profileEducation.value = currentVolunteerData.education || '';

                    // Set availability checkboxes
                    availabilityCheckboxes.forEach(checkbox => {
                        checkbox.checked = currentVolunteerData.availability && currentVolunteerData.availability.includes(checkbox.value);
                    });
                } else {
                    alert('Data profil tidak ditemukan.');
                    window.location.href = 'dashboard-relawan.html'; // Redirect if data not found
                }
            }

            // --- Save Profile Changes (Availability Only) ---
            saveProfileButton.addEventListener('click', async function (event) {
                event.preventDefault();

                const applicants = await loadApplicants();
                const volunteerIndex = applicants.findIndex(app => app.id === loggedInVolunteerId);

                if (volunteerIndex > -1) {
                    const updatedAvailability = Array.from(availabilityCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    applicants[volunteerIndex].availability = updatedAvailability;
                    saveApplicants(applicants);
                    alert('Perubahan ketersediaan berhasil disimpan!');
                    // Re-populate to ensure UI reflects saved state
                    populateProfile();
                } else {
                    alert('Gagal menyimpan perubahan. Data relawan tidak ditemukan.');
                }
            });

            // --- Validate Resignation Document ---
            function validateResignationDocument() {
                const file = resignationDocumentInput.files[0];
                if (!file) {
                    displayError(resignationDocumentInput, resignationDocumentError, 'Mohon unggah dokumen pengunduran diri.');
                    return false;
                }

                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > MAX_FILE_SIZE_MB) {
                    displayError(resignationDocumentInput, resignationDocumentError, `Ukuran file maksimal ${MAX_FILE_SIZE_MB}MB.`);
                    resignationDocumentInput.value = '';
                    return false;
                }

                if (!ALLOWED_FILE_TYPES.includes(file.type)) {
                    displayError(resignationDocumentInput, resignationDocumentError, 'Format file tidak didukung (PDF, DOCX, JPG, PNG).');
                    resignationDocumentInput.value = '';
                    return false;
                }

                displayError(resignationDocumentInput, resignationDocumentError, '');
                return true;
            }

            function displayError(inputElement, errorElement, message) {
                if (message) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                } else {
                    errorElement.textContent = '';
                    errorElement.style.display = 'none';
                }
            }

            resignationDocumentInput.addEventListener('change', validateResignationDocument);

            // --- Resign Functionality ---
            resignButton.addEventListener('click', async function () {
                if (!validateResignationDocument()) {
                    return;
                }

                if (confirm('Apakah Anda yakin ingin mengajukan pengunduran diri? Status Anda akan diubah dan Anda akan logout.')) {
                    const applicants = await loadApplicants();
                    const volunteerIndex = applicants.findIndex(app => app.id === loggedInVolunteerId);

                    if (volunteerIndex > -1) {
                        applicants[volunteerIndex].status = 'mengundurkan_diri'; // New status for resignation
                        // Optionally, you can also add a field for the resignation document name
                        applicants[volunteerIndex].resignation_document = resignationDocumentInput.files[0] ? resignationDocumentInput.files[0].name : null;
                        applicants[volunteerIndex].resignation_date = new Date().toISOString(); // Record resignation date

                        // --- [NEW] Create Admin Notification ---
                        const adminNotificationsKey = 'adminNotificationsData';
                        let adminNotifications = JSON.parse(localStorage.getItem(adminNotificationsKey) || '[]');
                        adminNotifications.push({
                            id: 'notif-' + Date.now(),
                            type: 'resignation',
                            message: `Relawan ${currentVolunteerData.name} mengajukan pengunduran diri.`,
                            volunteerId: loggedInVolunteerId,
                            timestamp: new Date().toISOString(),
                            read: false
                        });
                        localStorage.setItem(adminNotificationsKey, JSON.stringify(adminNotifications));

                        saveApplicants(applicants);
                        alert('Pengajuan pengunduran diri Anda telah diterima. Anda akan logout.');

                        // Clear user session and redirect to login
                        localStorage.removeItem('loggedInUser');
                        localStorage.removeItem('loggedInUserEmail');
                        localStorage.removeItem('loggedInUserRole');
                        localStorage.removeItem('loggedInVolunteerId');
                        // Clear any user-specific assignments or notifications
                        localStorage.removeItem('userAssignments_' + loggedInUser);
                        localStorage.removeItem('userNotifications_' + loggedInUser);

                        window.location.href = 'login.html';
                    } else {
                        alert('Gagal mengajukan pengunduran diri. Data relawan tidak ditemukan.');
                    }
                }
            });
            // --- Toggle Resignation Section ---
            toggleResignButton.addEventListener('click', function () {
                const isHidden = resignationSection.style.display === 'none';
                if (isHidden) {
                    resignationSection.style.display = 'block';
                    this.textContent = 'Batalkan Pengunduran Diri';
                    // Optional: scroll to the section
                    resignationSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    resignationSection.style.display = 'none';
                    this.textContent = 'Opsi Pengunduran Diri';
                }
            });

            // --- Initial Load ---
            populateProfile();
        });
    </script>

</body>

</html>